<?php
    require_once 'excel/phpexcel/Classes/PHPExcel.php';
    require_once 'excel/phpexcel/Classes/PHPExcel/IOFactory.php';
    require_once 'clients/CamemisExcelReport.php';
    require_once 'clients/CamemisExportToExcel.php';
    require_once 'models/app_school/AcademicDateDBAccess.php';
    require_once 'models/app_school/assignment/AssignmentDBAccess.php';
    require_once 'models/app_school/academic/AcademicDBAccess.php';
    require_once 'models/app_school/evaluation/default/StudentAssignmentDBAccess.php';
    require_once 'models/app_school/student/StudentAcademicDBAccess.php'; 
    require_once 'models/app_school/subject/SubjectDBAccess.php';
    require_once 'models/app_school/staff/StaffDBAccess.php'; 
    $exportToExcel = new CamemisExportToExcel();  
 
    $params["classId"] = $this->classId;
    $params["subjectId"] = $this->subjectId;
    $params["assignmentId"] = $this->assignmentId;
    $params["teacherId"] = $this->teacherId;
    $params["date"] = $this->date;
    $params["start"] = 0;
    $params["limit"] = 100;

    //school information
    $schoolObject = $exportToExcel->getSchoolInfo();
    $SchoolName = $schoolObject->NAME;
    $SchoolAdress=$schoolObject->ADDRESS;
    $schoolInfo= $SchoolName."\n".$SchoolAdress;
    //score info
    $facette = AcademicDBAccess::findGradeFromId($this->classId);
    $subjectObject = SubjectDBAccess::findSubjectClass($this->subjectId, $facette->ID);
    
    if (!$facette) {header("Location: /main/permission/");}
    //school year
    $academicObject=AcademicDateDBAccess::findAcademicDateFromId($facette->SCHOOL_YEAR);
    $academicDate= $academicObject->NAME;
    //class name
    $academicObject = AcademicDBAccess::findClass($subjectObject->CLASS);
    $classInfo=$academicObject->NAME;
    //teacher
    $teacherObject = StaffDBAccess::findStaffFromId($this->teacherId);
    $teachers = $teacherObject->NAME;
    //subject
    $subjectObject=SubjectDBAccess::findSubjectFromId($subjectObject->SUBJECT);
    $subjects= $subjectObject->NAME." (".$subjectObject->SHORT.")";
    
    $schoolname = SCHOOL.": ".$schoolObject->NAME;
    $schoolyear = SCHOOL_YEAR.": ".$academicDate;
    $classname = GRADE_CLASS.": ".$classInfo;
    $teacher = TEACHER.": ".$teachers;
    $subject = SUBJECT.": ".$subjects;
    //$month = MONTH.": ";
    $scoreinfo=$schoolname."\n".$schoolyear."\n".$classname."\n".$teacher."\n".$subject;
 
    $managementscore = new StudentAssignmentDBAccess();
    $results = $managementscore->jsonListStudentsTeacherEnterScore($params, false);
    $filds[0] = "NA";
    $showfilds[0] = "NÂ°";
    $i = 1;
    $j = 0;
    
    $char=array("A","B","C","D","E","F");
    switch (strtoupper($this->type)){          
      case "SUBJECTSCOREENTER":
            $SUBJECTSCOREENTER_EXPORT = array('CODE_ID','FULL_NAME','SCORE','COMMENT_BY_TEACHER');
            $SUBJECTSCOREENTER = array('CODE','STUDENT','SCORE','TEACHER_COMMENTS');
            foreach($SUBJECTSCOREENTER_EXPORT as $index){     
                    $filds[$i]= $SUBJECTSCOREENTER[$j];
                    $showfilds[$i] = defined($index) ? constant($index) : $index;
                    ++$i;   
               $j++;
            }  
            
            $endCharExcel = $char[$i - 1];
            $fileName = strtolower('SUBJECTSCOREENTER') . "_" . getCurrentDBDate();
            break;
    }

    $objPHPExcel=$exportToExcel->objExcel($results,$filds,$showfilds,3);
    $info['SCHOOL_INFO']=$schoolInfo;
    $info['CLASS_INFO']=$scoreinfo;  
    $exportToExcel->excelHeader($info,1,$endCharExcel); 
    $exportToExcel->excelFooter();
    if($results){
        $j=2;
        $count = count($results)+3;
        foreach ($results as $value){           
                $objPHPExcel->getActiveSheet()->getProtection()->setPassword('PHPExcel'); 
                $objPHPExcel->getActiveSheet()->getProtection()->setSheet(true); 
                $objPHPExcel->getActiveSheet()->getProtection()->setSort(true); 
                $objPHPExcel->getActiveSheet()->getProtection()->setInsertRows(true); 
                $objPHPExcel->getActiveSheet()->getProtection()->setFormatCells(true);
                $objPHPExcel->getActiveSheet()->getStyle('D4:E'.$count)->getProtection()->setLocked( PHPExcel_Style_Protection::PROTECTION_UNPROTECTED );
            }
            $j++;
        }
                
    $exportToExcel->save($fileName);
?>                                  