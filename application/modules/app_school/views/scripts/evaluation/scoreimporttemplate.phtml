<?
////////////////////////////////////////////////////////////////////////////////
// @Kaom Vibolrith Senior Software Developer
// Date: 31.03.2014
// Am Stollheen 18, 55120 Mainz, Germany
////////////////////////////////////////////////////////////////////////////////

require_once("Zend/Loader.php");
require_once 'models/export/CamemisExportDBAccess.php';
require_once 'models/export/CamemisExportDBAccess.php';

$academicId = isset($_GET["academicId"])?addText($_GET["academicId"]):"";
$subjectId = isset($_GET["subjectId"])?addText($_GET["subjectId"]):"";
$assignmentId = isset($_GET["assignmentId"])?addText($_GET["assignmentId"]):"";
$date = isset($_GET["date"])?addText($_GET["date"]):"";
$term = isset($_GET["term"])?addText($_GET["term"]):"";

class myExportDBAccess extends CamemisExportDBAccess {
    
    function __construct($academicId, $subjectId, $assignmentId, $term, $date) {
        
        $this->academidId = $academicId*1;
        $this->subjectId = $subjectId*1;
        $this->assignmentId = $assignmentId*1;
        $this->term = $term;
        $this->date = $date;
        
        $this->evaluation = new EvaluationSubjectAssessment();
        $this->evaluation->setAcademicId($this->academidId);
        
        $this->startHeader = 2;
        
        parent::__construct();
    }
    
    public function getFileName()
    {
        return "../public/" . UserAuth::getMyFolder() . "/" . UserAuth::getUserId() . "_scoreimporttemplate.xls";
    }
    
    public function setTableHeader(){
        
        $this->setCellContent(0, 1, CODE_ID);
        $this->setFontStyle(0, 1, true, 14, "000000");
        $this->setFullStyle(0, 1, "DFE3E8");
        $this->setCellStyle(0, 1, 100, 40);
        
        $this->setCellContent(0, $this->startHeader, CODE_ID);
        $this->setFontStyle(0, $this->startHeader, true, 11, "000000");
        $this->setFullStyle(0, $this->startHeader, "DFE3E8");
        $this->setCellStyle(0, $this->startHeader, 20, 40);
        
        $this->setCellContent(1, $this->startHeader, STUDENT);
        $this->setFontStyle(1, $this->startHeader, true, 11, "000000");
        $this->setFullStyle(1, $this->startHeader, "DFE3E8");
        $this->setCellStyle(1, $this->startHeader, 30, 40);
        
        $this->setCellContent(2, $this->startHeader, SCORE);
        $this->setFontStyle(2, $this->startHeader, true, 11, "000000");
        $this->setFullStyle(2, $this->startHeader, "DFE3E8");
        $this->setCellStyle(2, $this->startHeader, 20, 40);
    }
    
    public function setTableContent() {
        
        $entries = $this->evaluation->listStudentsData();
        
        if ($entries) {

            $i = 0;
            $colIndex = 0;
            
            foreach ($evaluation->listClassStudents() as $value) {
                
                $rowIndex = $i + $this->startContent();
                
                $STUDENT = getFullName($value->FIRSTNAME, $value->LASTNAME);
                
                $this->setCellContent(0, $rowIndex, $value->CODE);
                $this->setFontStyle(0, $rowIndex, false, 9, "000000");
                $this->setCellStyle(0, $rowIndex, false, 20);
                
                $this->setCellContent(1, $rowIndex, $STUDENT);
                $this->setFontStyle(1, $rowIndex, false, 9, "000000");
                $this->setCellStyle(1, $rowIndex, false, 20);
                
                $this->setCellContent(2, $rowIndex, "");
                $this->setFontStyle(2, $rowIndex, false, 9, "000000");
                $this->setCellStyle(2, $rowIndex, false, 20);
                
                $i++;
            }
        }
    }
    
    public function setSaveExcel(){
        
        $this->EXCEL->setActiveSheetIndex(0);
        $this->setTableHeader();
        $this->setTableContent();
        $this->EXCEL->getActiveSheet()->setTitle("" . LIST_OF_STUDENTS . "");
        $this->WRITER->save($this->getFileName());
    }
}

$MY_EXPORT = new myExportDBAccess($academicId, $subjectId, $assignmentId, $term, $date);
$MY_EXPORT->setSaveExcel();

$fileName = UserAuth::getUserId()."_scoreimporttemplate.xls";
$exportFile = "../public/" . UserAuth::getMyFolder() . "/" . $fileName . "";

header("Content-Type: application/x-msexcel;");
header("Content-Disposition: attachment; filename=\"" . $fileName . "\"");
// IE <= 6 cache fix
header('Expires: 0');
header('Pragma: cache');
header('Cache-Control: private');

if (file_exists($exportFile)) {
    $fh = fopen($exportFile, 'r');
    fpassthru($fh);
    fclose($fh);
    unlink($exportFile);
}
?>