<?
require_once("Zend/Loader.php");
require_once 'clients/CamemisPage.php';
require_once 'models/app_university/academic/AcademicDBAccess.php';
require_once 'models/app_university/subject/SubjectDBAccess.php';
require_once setUserLoacalization();

if ($_POST){
    
    $subjectId = isset($_POST["subjectId"])?$_POST["subjectId"]:"";
    $studentId = isset($_POST["id"])?$_POST["id"]:"";
    $academicId = isset($_POST["academicId"])?$_POST["academicId"]:"";
    $monthyear = isset($_POST["monthyear"])?$_POST["monthyear"]:"";
    $section = isset($_POST["section"])?$_POST["section"]:"";
    $term = isset($_POST["term"])?$_POST["term"]:"";
    
    if($subjectId){
        $useObject = StudentSubjectAssessment::getInstance();
        $useObject->jsonActionStudentSubjectAssessment($_POST,true);
    }else{
        $useObject = StudentTraditionalPerformance::getInstance();
        $useObject->jsonActionStudentClassPerformance($_POST,true);
    }
    
    header("Location: ".$_SERVER['REQUEST_URI']."");
}else{
    
    $section = isset($_GET['section'])?$_GET['section']:"";
    $subjectId = isset($_GET['subjectId'])?$_GET['subjectId']:"";
    $academicId = $this->academicId;
    $monthyear = $this->monthyear;
    $studentId = $this->studentId;
    $term = $this->term;
}

if($subjectId){
    
    $useObject = StudentSubjectAssessment::getInstance();
    $academicObject = AcademicDBAccess::findGradeFromId($academicId);
    $useObject->academicId = $academicObject->ID;
    $useObject->section = $section;
    $useObject->term = $term;
    if($monthyear){
        $useObject->month = getMonthNumberFromMonthYear($monthyear);
        $useObject->year = getYearFromMonthYear($monthyear);
    }
    $facette = $useObject->getStudentSubjectAssessment($studentId, $subjectId,false);
    
}else{
    $useObject = StudentTraditionalPerformance::getInstance();
    $academicObject = AcademicDBAccess::findGradeFromId($academicId);
    $useObject->academicId = $academicObject->ID;
    $useObject->studentId = $studentId;
    $useObject->section = $section;
    $useObject->term = $term;

    if($monthyear){
        $useObject->month = getMonthNumberFromMonthYear($monthyear);
        $useObject->year = getYearFromMonthYear($monthyear);
    }
    $facette = $useObject->getStudentPerformance();
}
$TEACHER_COMMENT = $facette?$facette->TEACHER_COMMENT:"---";

$SHOW_EDITOR = "";

switch(UserAuth::getUserType()){
    case 'STUDENT':
        $SHOW_EDITOR = "
            CKEDITOR.replace( 'comment',{
                language:'".CamemisPage::ckeditorLanguage()."'
                ,height:350
                ,readOnly: true
                ,uiColor: '#e0e7f7'
                ,toolbar :
                [
                    { name: 'document', items : [ 'Print'] }
                    ,{ name: 'basicstyles', items : [ 'Bold','Italic' ] }
                    ,{ name: 'paragraph', items : [ 'NumberedList','BulletedList' ] }
                    ,{ name: 'insert', items : [ 'Table','HorizontalRule','SpecialChar','PageBreak'] }
                    ,{ name: 'tools', items : [ 'Maximize','-','About' ] }
                ]
            });
        ";
        break;
    case 'SUPERADMIN':
    case 'ADMIN':
    case 'INSTRUCTOR':
    case 'TEACHER':
        $SHOW_EDITOR = "
            CKEDITOR.replace( 'comment',{
                language:'".CamemisPage::ckeditorLanguage()."'
                ,height:350
                ,uiColor: '#e0e7f7'
                ,toolbar :
                [
                    { name: 'document', items : [ 'Save','DocProps','Print'] }
                    ,{ name: 'basicstyles', items : [ 'Bold','Italic' ] }
                    ,{ name: 'paragraph', items : [ 'NumberedList','BulletedList' ] }
                    ,{ name: 'insert', items : [ 'Table','HorizontalRule','SpecialChar','PageBreak'] }
                    ,{ name: 'tools', items : [ 'Maximize','-','About' ] }
                ]
            });
        "; 
    break;
}

?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>CAMEMIS</title>
<meta content="text/html; charset=utf-8" http-equiv="content-type" />
<script type="text/javascript" src="/public/ckeditor/ckeditor.js"></script>
<link href="/public/ckeditor/samples/sample.css" rel="stylesheet" type="text/css" />
</head>
<body style='background:#e0e7f7;'>
   <form action="" method="post">
    <textarea id="comment" name="comment"><?=$TEACHER_COMMENT;?></textarea>
    <script type="text/javascript">
        //<![CDATA[ 
        CKEDITOR.on('instanceReady',function(evt){
            var editor = evt.editor;
            editor.execCommand('maximize');
        });
        <?= $SHOW_EDITOR;?>
        //]]>
    </script> 
    <input type="hidden" name="id" value="<?=$this->studentId?>">
    <input type="hidden" name="academicId" value="<?=$this->academicId;?>">  
    <input type="hidden" name="term" value="<?=$this->term;?>">  
    <input type="hidden" name="section" value="<?=$section;?>">  
    <input type="hidden" name="monthyear" value="<?=$this->monthyear;?>">  
    <input type="hidden" name="subjectId" value="<?=$this->subjectId;?>">      
    </form>
</body>
</html>