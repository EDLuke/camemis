<?php
    require_once 'excel/phpexcel/Classes/PHPExcel.php';
    require_once 'excel/phpexcel/Classes/PHPExcel/IOFactory.php';
    require_once 'clients/CamemisExcelReport.php';
    require_once 'clients/CamemisExportToExcel.php';
    require_once 'models/app_university/AcademicDateDBAccess.php';
    require_once 'models/app_university/assignment/AssignmentDBAccess.php';
    require_once 'models/app_university/training/TrainingDBAccess.php';
    require_once 'models/app_university/evaluation/default/StudentAssignmentDBAccess.php';
    require_once 'models/app_university/subject/TrainingSubjectDBAccess.php';
    require_once 'models/app_university/student/StudentAcademicDBAccess.php'; 
    require_once 'models/app_university/subject/SubjectDBAccess.php';
    require_once 'models/app_university/staff/StaffDBAccess.php'; 
    $exportToExcel = new CamemisExportToExcel();  
    
    $params["subjectId"] = $this->subjectId;
    $params["objectId"] = $this->objectId;
    $params["studentId"] = $this->studentId;     
    $params["teacherId"] = $this->teacherId;
    $params["start"] = 0;
    $params["limit"] = 100;

    //school information
    $schoolObject = $exportToExcel->getSchoolInfo();
    $SchoolName = $schoolObject->NAME;
    $SchoolAdress=$schoolObject->ADDRESS;
    $schoolInfo= $SchoolName."\n".$SchoolAdress;
    //score info
    $facette = TrainingDBAccess::findTrainingFromId($this->objectId);
    if (!$facette) {header("Location: /main/permission/");}
    //school year
    $academicDate= $facette->START_DATE." - ".$facette->END_DATE;
    //class name
    $classInfo=$facette->NAME;
    //teacher
    $teacherObject = StaffDBAccess::findStaffFromId($this->teacherId);
    $teachers = $teacherObject->NAME;
    //subject
    $subjectObject=SubjectDBAccess::findSubjectFromId($this->subjectId);
    $subjects= $subjectObject->NAME." (".$subjectObject->SHORT.")";
    
    $schoolname = SCHOOL.": ".$schoolObject->NAME;
    $schoolyear = LEVEL.": ".$academicDate;
    $classname = GRADE_CLASS.": ".$classInfo;
    $teacher = TEACHER.": ".$teachers;
    $subject = SUBJECT.": ".$subjects;
    //$month = MONTH.": ";
    $scoreinfo=$schoolname."\n".$schoolyear."\n".$classname."\n".$teacher."\n".$subject;
    $ENTRIES_ASSIGNMENT = TrainingSubjectDBAccess::getTrainingAssignments($this->subjectId, $this->objectId);
    $managementscore = new StudentTrainingDBAccess();
    $results = $managementscore->jsonStudentSubjectAssignment($params, false);

    $filds[0] = "NA";
    $showfilds[0] = "NÂ°";
    $i = 1;
    $j = 0;
    
    $char=array("A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","AA","AB","AC","AD","AE","AF","AG","AH","AI",'AJ',"AK","AL","AM","AN","AO","AP","AQ","AR","AS","AT","AU","AV","AW","AY","AZ");
    switch (strtoupper($this->type)){      
      case "SUBJECTSCOREENTERTRAINING":
            $SUBJECTSCOREENTER_EXPORT = array('CODE_ID','FULL_NAME');
            $SUBJECTSCOREENTER = array('CODE','FULL_NAME');
            foreach($SUBJECTSCOREENTER_EXPORT as $index){     
                    $filds[$i]= $SUBJECTSCOREENTER[$j];
                    $showfilds[$i] = defined($index) ? constant($index) : $index;
                    ++$i;   
               $j++;
            }
            
            foreach($ENTRIES_ASSIGNMENT as $key=>$value){
                $filds[$i]= 'ASSIGNMENT_'.$value->ID;
                $showfilds[$i] = $value->NAME;
                ++$i;   
                $j++;
            }  
            
            $endCharExcel = $char[$i - 1];
            $fileName = strtolower('SUBJECTSCOREENTERTRAINING') . "_" . getCurrentDBDate();
            break;
    }

    $objPHPExcel=$exportToExcel->objExcel($results,$filds,$showfilds,3);
    $info['SCHOOL_INFO']=$schoolInfo;
    $info['CLASS_INFO']=$scoreinfo;  
    $exportToExcel->excelHeader($info,1,$endCharExcel); 
    $exportToExcel->excelFooter();
    if($results){
        $j=2;
        $count = count($results)+3;        
        $objPHPExcel->getActiveSheet()->getProtection()->setPassword('PHPExcel'); 
        $objPHPExcel->getActiveSheet()->getProtection()->setSheet(true); 
        $objPHPExcel->getActiveSheet()->getProtection()->setSort(true); 
        $objPHPExcel->getActiveSheet()->getProtection()->setInsertRows(true); 
        $objPHPExcel->getActiveSheet()->getProtection()->setFormatCells(true);
        $objPHPExcel->getActiveSheet()->getStyle('D4:'.$endCharExcel.$count)->getProtection()->setLocked( PHPExcel_Style_Protection::PROTECTION_UNPROTECTED );
    }
                
    $exportToExcel->save($fileName);
?>                                  